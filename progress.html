<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Student Progress Entry</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="navbar-logic.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h2 {
      color: #667eea;
      margin-bottom: 20px;
      text-align: center;
    }

    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: 600;
      color: #333;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    th {
      background: #667eea;
      color: white;
    }

    .btn {
      padding: 12px 25px;
      margin: 10px 5px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .alert {
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      display: none;
    }

    .alert.success {
      background: #d1fae5;
      color: #065f46;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .alert.show {
      display: block;
    }
  </style>
</head>

<body>
  <div id="nav"></div>
  <script>
    fetch("navbar.html").then(r => r.text()).then(t => {
      document.getElementById("nav").innerHTML = t;
      initNavbarLogic();
    });
  </script>

  <div class="container">
    <h2>ðŸ“Š Student Progress Entry</h2>

    <div id="alertBox" class="alert"></div>

    <label>Student Name *</label>
    <input id="studentName" placeholder="Enter student name">

    <label>Class *</label>
    <select id="classSelect">
      <option value="">Select Class</option>
      <option value="1">Class 1</option>
      <option value="2">Class 2</option>
      <option value="3">Class 3</option>
      <option value="4">Class 4</option>
      <option value="5">Class 5</option>
      <option value="6">Class 6</option>
      <option value="7">Class 7</option>
      <option value="8">Class 8</option>
      <option value="9">Class 9</option>
      <option value="10">Class 10</option>
    </select>

    <label>Exam Type *</label>
    <select id="examType">
      <option value="">Select Exam Type</option>
      <option value="FA1">Formative Assessment 1 (FA1)</option>
      <option value="FA2">Formative Assessment 2 (FA2)</option>
      <option value="SA1">Summative Assessment 1 (SA1)</option>
      <option value="SA2">Summative Assessment 2 (SA2)</option>
      <option value="Final">Final Exam</option>
    </select>

    <table id="subjectRows">
      <tr>
        <th>Subject</th>
        <th>Max Marks</th>
        <th>Obtained</th>
      </tr>
      <tr>
        <td>Telugu</td>
        <td><input type="number" class="max-marks" value="100" min="0"></td>
        <td><input type="number" class="obtained-marks" value="0" min="0"></td>
      </tr>
      <tr>
        <td>Hindi</td>
        <td><input type="number" class="max-marks" value="100" min="0"></td>
        <td><input type="number" class="obtained-marks" value="0" min="0"></td>
      </tr>
      <tr>
        <td>English</td>
        <td><input type="number" class="max-marks" value="100" min="0"></td>
        <td><input type="number" class="obtained-marks" value="0" min="0"></td>
      </tr>
      <tr>
        <td>Mathematics</td>
        <td><input type="number" class="max-marks" value="100" min="0"></td>
        <td><input type="number" class="obtained-marks" value="0" min="0"></td>
      </tr>
      <tr>
        <td>Science</td>
        <td><input type="number" class="max-marks" value="100" min="0"></td>
        <td><input type="number" class="obtained-marks" value="0" min="0"></td>
      </tr>
      <tr>
        <td>Social Studies</td>
        <td><input type="number" class="max-marks" value="100" min="0"></td>
        <td><input type="number" class="obtained-marks" value="0" min="0"></td>
      </tr>
    </table>

    <button class="btn btn-primary" id="saveMarks">ðŸ’¾ Save Progress</button>
    <button class="btn btn-secondary" id="clearForm">ðŸ”„ Clear Form</button>

    <h2 style="margin-top: 40px;">ðŸ“š Saved Records</h2>
    <div id="recordsContainer">Loading...</div>
  </div>

  <script>
    function showAlert(message, type = 'success') {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = `alert ${type} show`;
      setTimeout(() => alertBox.classList.remove('show'), 5000);
    }

    // Save marks
    document.getElementById('saveMarks').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showAlert('Please login first', 'error');
        setTimeout(() => location.href = 'login.html', 1500);
        return;
      }

      const studentName = document.getElementById('studentName').value.trim();
      const classSelect = document.getElementById('classSelect').value;
      const examType = document.getElementById('examType').value;

      if (!studentName || !classSelect || !examType) {
        showAlert('Please fill all required fields', 'error');
        return;
      }

      const rows = document.querySelectorAll('#subjectRows tr');
      const marks = [];
      let totalObtained = 0;
      let totalMax = 0;

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        const subject = r.cells[0].textContent.trim();
        const maxMarks = Number(r.querySelector('.max-marks').value) || 0;
        const obtained = Number(r.querySelector('.obtained-marks').value) || 0;
        marks.push({ subject, maxMarks, obtained });
        totalObtained += obtained;
        totalMax += maxMarks;
      }

      const percentage = totalMax > 0 ? ((totalObtained / totalMax) * 100).toFixed(2) : 0;

      try {
        await db.collection('progress').add({
          studentName,
          class: classSelect,
          examType,
          marks,
          totalObtained,
          totalMax,
          percentage: Number(percentage),
          createdBy: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showAlert('âœ… Progress saved successfully!');
        document.getElementById('clearForm').click();
        loadRecords();
      } catch (error) {
        console.error('Error saving:', error);
        showAlert('âŒ Error: ' + error.message, 'error');
      }
    });

    // Clear form
    document.getElementById('clearForm').addEventListener('click', () => {
      document.getElementById('studentName').value = '';
      document.getElementById('classSelect').value = '';
      document.getElementById('examType').value = '';
      document.querySelectorAll('.obtained-marks').forEach(input => input.value = '0');
      document.querySelectorAll('.max-marks').forEach(input => input.value = '100');
    });

    // Load records - FIXED: No orderBy to avoid index requirement
    async function loadRecords() {
      const user = auth.currentUser;
      if (!user) {
        document.getElementById('recordsContainer').innerHTML = 'Please login to view records';
        return;
      }

      try {
        const snap = await db.collection('progress')
          .where('createdBy', '==', user.uid)
          .get();

        if (snap.empty) {
          document.getElementById('recordsContainer').innerHTML = 'No records found';
          return;
        }

        // Sort in JavaScript instead of Firestore
        const docs = snap.docs.sort((a, b) => {
          const aTime = a.data().createdAt?.toMillis() || 0;
          const bTime = b.data().createdAt?.toMillis() || 0;
          return bTime - aTime;
        });

        let html = '<table><tr><th>Student</th><th>Class</th><th>Exam</th><th>Marks</th><th>%</th></tr>';
        docs.forEach(doc => {
          const d = doc.data();
          html += `<tr>
            <td><strong>${d.studentName}</strong></td>
            <td>Class ${d.class}</td>
            <td>${d.examType}</td>
            <td>${d.totalObtained}/${d.totalMax}</td>
            <td>${d.percentage}%</td>
          </tr>`;
        });
        html += '</table>';
        document.getElementById('recordsContainer').innerHTML = html;
      } catch (error) {
        console.error('Error loading:', error);
        document.getElementById('recordsContainer').innerHTML = 'Error loading records';
      }
    }

    // Load on page load
    window.addEventListener('load', loadRecords);
  </script>
</body>

</html>